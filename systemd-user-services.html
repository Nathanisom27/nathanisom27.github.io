<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2021-01-03 Sun 17:05 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>systemd user services</title>
<meta name="generator" content="Org mode" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script data-goatcounter="https://neeasade.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
<link rel='stylesheet' href='/assets/css/org.css?sum=e359ca908a861b1cdcc3e0394ed5bce6'>
<link rel='stylesheet' href='./assets/css/org.css?sum=e359ca908a861b1cdcc3e0394ed5bce6'>
<link rel='stylesheet' href='/assets/css/colors.css?sum=97206a021034a32931377f372160a4ae'>
<link rel='stylesheet' href='./assets/css/colors.css?sum=97206a021034a32931377f372160a4ae'>
<link rel='stylesheet' href='/assets/css/notes.css?sum=31a320c058456258f196266b94ee5dea'>
<link rel='stylesheet' href='./assets/css/notes.css?sum=31a320c058456258f196266b94ee5dea'>
<link rel='stylesheet' href='/assets/css/new.css?sum=6005176a5b1e4f006c15ae303d1f2c3b'>
<link rel='stylesheet' href='./assets/css/new.css?sum=6005176a5b1e4f006c15ae303d1f2c3b'>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<p>
<h1 class=title><a href="/index.html">systemd user services</a> </h1>
</p>

<div class="org-center">
<p>
2021-01-02 (edited <a href="https://github.com/neeasade/neeasade.github.io/commits/source/posts/2020-12-31-systemd-user-services.org">2021-01-03</a>)
</p>
</div>

<hr />
<p>
This is a text version of a lighting talk I gave at <a href="https://www.recurse.com">recurse center</a> Feb 2020.
</p>

<p>
Back when I was first getting into Linux, I had arch installed on my laptop that I was using for schoolwork, and  was trying all the latest ｍｎｍｌ window managers, which meant there was no builtin display for how much battery I had left.
</p>

<p>
Some googling showed me that you could do the following to get the charge on linux:
</p>

<div class="org-src-container">
<pre class="src src-sh">$ cat /sys/class/power_supply/BAT0/capacity
92
</pre>
</div>

<p>
That's a pain to typeout, so I aliased it to something spamable like <code>a</code> and called it a day. But then&#x2026; suprise shutdowns still happened on occasion. So I just got into the habit of spamming checking all the time due to laptop FOMO. This is not ideal.
</p>

<p>
Next step was to wrap the above in a script and display it in my panel. Nice! now the battery status is always a glance away. BUT! pixel real estate is precious on my 1366 x 768 resolution, so I would often hide the panel or fullscreen something like media, or my text editor. We are back where we started.
</p>

<div id="outline-container-h-9c426974-626d-47cf-bca6-c2b71698b392" class="outline-2">
<h2 id="h-9c426974-626d-47cf-bca6-c2b71698b392"><span class="section-number-2">1</span> <a href="#h-9c426974-626d-47cf-bca6-c2b71698b392">Alerts</a></h2>
<div class="outline-text-2" id="text-h-9c426974-626d-47cf-bca6-c2b71698b392">
<p>
With something like dunst, I can send notifications that appear only when I'm concerned with them. This birthed a script that would only bother me if my battery was below a certain level, while polling periodially. I decoupled that last part into a script named <a href="https://github.com/neeasade/dotfiles/blob/master/wm/.wm/scripts/services/periodically"><code>periodically</code></a>, so ended up with a <code>battery_alert</code> daemon-like script that looked like <code>periodically 60 check_battery</code>.
</p>

<p>
Making this call in my <code>.xinitrc</code> worked out OK, but I'm sometimes at a desktop using the same set of dotfiles, and there's no battery to check there. About this point I realized I had stuffed a lot in my startup, such as <code>mpd</code>, <code>picom</code>, <code>dunst</code>, you name it. I had heard of systemd user services and decided to look into them.
</p>
</div>
</div>


<div id="outline-container-h-bedee5e8-3ef1-4038-9bc8-33640146db06" class="outline-2">
<h2 id="h-bedee5e8-3ef1-4038-9bc8-33640146db06"><span class="section-number-2">2</span> <a href="#h-bedee5e8-3ef1-4038-9bc8-33640146db06">The big D</a></h2>
<div class="outline-text-2" id="text-h-bedee5e8-3ef1-4038-9bc8-33640146db06">
<p>
Systemd user services are regular systemd service files that live in <code>$HOME/.config/systemd/user</code>. A service file matching the above problem might look like this:
</p>

<p>
<code>battery_alert.service</code>:
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span style="color: #8a4d38;">Unit</span>]
<span style="color: #903f7a;">Description</span>=Notify when the battery is low

[<span style="color: #8a4d38;">Service</span>]
<span style="color: #903f7a;">ExecStart</span>=/path/to/bin/periodically 60 check_battery
<span style="color: #903f7a;">ExecStop</span>=/path/to/bin/kill -int $MAINPID

<span style="color: #903f7a;">Environment</span>=PATH=/paths/that/contain/check_battery:...:....
<span style="color: #903f7a;">Environment</span>=DISPLAY=<span style="color: #4f6600;">":0"</span>
<span style="color: #903f7a;">Environment</span>=XAUTHORITY=<span style="color: #4f6600;">"/home/neeasade/.Xauthority"</span>

[<span style="color: #8a4d38;">Install</span>]
<span style="color: #903f7a;">WantedBy</span>=default.target
</pre>
</div>

<p>
Some things to note:
</p>

<ul class="org-ul">
<li>The full path to the <code>ExecStart</code> and <code>ExecStop</code> executables</li>
<li>The inclusion of <code>DISPLAY</code> and <code>XAUTHORITY</code> &#x2013; this is so the <code>notify-send</code> reaches dunst</li>
<li>The setting of <code>PATH</code> such that "the usual suspects" are available within my daemon script</li>
</ul>

<p>
With the above I get the systemd goodness but for managing my local stuff, just passing <code>--user</code>:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span style="color: #a94e2f;"># </span><span style="color: #a94e2f;">start, stop</span>
systemctl --user start battery_alert
systemctl --user stop battery_alert

<span style="color: #a94e2f;"># </span><span style="color: #a94e2f;">logs (can also tail theme)</span>
systemctl --user status battery_alert

<span style="color: #a94e2f;"># </span><span style="color: #a94e2f;">automatic startup</span>
systemctl --user enable battery_alert
</pre>
</div>

<p>
So the next step in this systemd journey was to integrate <a href="https://github.com/neeasade/dotfiles/blob/cd6a4cd7c8207b7300bf0bf75f87aee8a7e4fbc1/wm/.wm/scripts/theming/ltheme#L379-L465">service generation</a> into my dotfiles setup, generating a number of service files that contain paths to binaries and
</p>
</div>
</div>

<div id="outline-container-h-42fac00e-07ec-4d8d-849f-eaf1a86bb935" class="outline-2">
<h2 id="h-42fac00e-07ec-4d8d-849f-eaf1a86bb935"><span class="section-number-2">3</span> <a href="#h-42fac00e-07ec-4d8d-849f-eaf1a86bb935">The big.. T?</a></h2>
<div class="outline-text-2" id="text-h-42fac00e-07ec-4d8d-849f-eaf1a86bb935">
<p>
Those of you in the know will see something very wrong with the above. Systemd has a "when to run" concept: <a href="https://www.freedesktop.org/software/systemd/man/systemd.timer.html">timers</a>! Using timers files you can do things like:
</p>

<ul class="org-ul">
<li>run on boot</li>
<li>run on login</li>
<li>run once per day/once per time interval</li>
<li>run <b>periodically</b></li>
</ul>

<p>
Let's take a look at what that last one looks like. You create a file in the same directory with the same name, but extension timer:
</p>

<p>
<code>battery_alert.timer</code>:
</p>
<div class="org-src-container">
<pre class="src src-conf">[<span style="color: #8a4d38;">Unit</span>]
<span style="color: #903f7a;">Description</span>=Run check_battery every 60 seconds

[<span style="color: #8a4d38;">Timer</span>]

<span style="color: #a94e2f;"># </span><span style="color: #a94e2f;">on boot</span>
<span style="color: #a94e2f;"># </span><span style="color: #a94e2f;">OnBootSec=0min</span>

<span style="color: #a94e2f;"># </span><span style="color: #a94e2f;">on service manager activation</span>
<span style="color: #903f7a;">OnStartupSec</span>=0min

<span style="color: #903f7a;">OnUnitActiveSec</span>=60s

[<span style="color: #8a4d38;">Install</span>]
<span style="color: #903f7a;">WantedBy</span>=timers.target
</pre>
</div>

<p>
See the reference for timespan syntax <a href="https://www.freedesktop.org/software/systemd/man/systemd.time.html#">here</a>
</p>

<p>
And then we would change the <code>ExecStart</code> in our <code>battery_alert.service</code> file to:
</p>

<div class="org-src-container">
<pre class="src src-conf"><span style="color: #903f7a;">ExecStart</span>=/path/to/check_battery
</pre>
</div>

<p>
And bam! we have done the thing.
</p>

<hr />

<div class="org-center">
<p>
<a href="./index.html">Index</a> <a href="https://neeasade.net">Root</a> <a href="https://raw.githubusercontent.com/neeasade/neeasade.github.io/source/posts/2020-12-31-systemd-user-services.org">Source</a> <a href="https://notes.neeasade.net/sitemap.html">Sitemap</a>
</p>
</div>

<div class="org-center">
<a href='https://webring.xxiivv.com/#random' target='_blank'><img style='width:40px;height:40px' src='https://webring.xxiivv.com/icon.black.svg'/></a>
<a href='https://github.com/nixers-projects/sites/wiki/List-of-nixers.net-user-sites' target='_blank'><img style='width:35px;height:40px' src='https://i.imgur.com/cttKKiq.png'/></a>
<a href='https://webring.recurse.com'><img alt='Recurse Center Logo' src='https://resevoir.net/webring/icon.png' style='height:40px;width:40px;'></a>
</div>
</div>
</div>
</div>
</body>
</html>
