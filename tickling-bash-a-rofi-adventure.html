<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2021-01-25 Mon 06:58 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>tickling bash, quest for the perfect menu</title>
<meta name="generator" content="Org mode">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="/assets/js/linktext.js" defer></script>
<script data-goatcounter="https://neeasade.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
<script src="//instant.page/5.1.0" type="module" integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw"></script>
<link rel='stylesheet' href='/assets/css/org.css?sum=19824060f71383b34e196f76ea8c38f1'>
<link rel='stylesheet' href='./assets/css/org.css?sum=19824060f71383b34e196f76ea8c38f1'>
<link rel='stylesheet' href='/assets/css/colors.css?sum=240418263c5058930b4a990579be0d79'>
<link rel='stylesheet' href='./assets/css/colors.css?sum=240418263c5058930b4a990579be0d79'>
<link rel='stylesheet' href='/assets/css/notes.css?sum=c3cda81516f39387cfbdc4376d91123f'>
<link rel='stylesheet' href='./assets/css/notes.css?sum=c3cda81516f39387cfbdc4376d91123f'>
<link rel='stylesheet' href='/assets/css/new.css?sum=4868ab8522b4e4059bfc5213fd799d61'>
<link rel='stylesheet' href='./assets/css/new.css?sum=4868ab8522b4e4059bfc5213fd799d61'>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="content">
<div style="float: left">
    <a href='/index.html'>Up: ＧＲＯＶＥ</a>
</div>

<div style="float: right">
    <a href="https://github.com/neeasade/neeasade.github.io/commits/source/posts/2020-05-10-tickling-bash,-a-rofi-adventure.org">Last edit: <2021-01-22></a>
</div>

<p>
<h1 class=title>tickling bash, quest for the perfect menu</h1>
</p>

<div class="org-center">
<p>
where the &rsquo;perfect menu&rsquo; means you can start typing right away        
</p>
</div>


<hr>

<p>
<b>tl;dr</b>: I wanted to stop reading stdin after the first newline to stdout, and I did a hacky thing to get that, the essence of which is:
</p>

<div class="org-src-container">
<pre class="src src-sh">sh -c <span style="color: #007c00;">'echo $$; echo a; sleep 100; echo b'</span> | (<span style="color: #0065c8;">read</span> pid; <span style="color: #0065c8;">read</span> line; <span style="color: #0065c8;">echo</span> <span style="color: #007c00;">"$line"</span>; <span style="color: #0065c8;">kill</span> $<span style="color: #c6007f;">pid</span>)
</pre>
</div>

<p>
I really like selecting things from fuzzy searchin&rsquo; keyboard-driven menus. There&rsquo;s something magical
about being able to bring up a menu, mash a few buttons, and get to where you are going. There are
lots of really cool generic &ldquo;select thing from list&rdquo; programs out there. As time goes on, you think
of more things you might do, and some take <a href="https://www.youtube.com/watch?v=NqbHe9X4PWU">it</a> <a href="https://github.com/BelkaDev/RofiFtw">really</a> <a href="https://keminglabs.com/finda/">far</a>.
</p>

<div id="outline-container-org53cf767" class="outline-2">
<h2 id="org53cf767"><span class="section-number-2">1</span> Setup</h2>
<div class="outline-text-2" id="text-1">
<p>
Let&rsquo;s go through some history first. dmenu2 was my goto &rsquo;selector&rsquo; for years, because it has some
neat features like positional arguments and the ability to specify the colorscheme from Xresources.
In my day to day, occasionally I would find a neat use or have a cool idea, and then integrate it
into my setup. Stuff like &ldquo;search mpd songs and insert one at the current playlist position&rdquo; or
&ldquo;select a password to copy into the clipboard&rdquo;. Wow this is all super cool! We can just do things
and integrate them with little script ideas, neat.
</p>

<p>
Eventually I had a hankering for a &ldquo;mega dmenu script&rdquo;. I&rsquo;d seen rofi here and there, and one of
it&rsquo;s features was a builting &ldquo;switch to window by title&rdquo; feature, which is pretty cool! I right away
stole the idea in a <a href="https://github.com/neeasade/dotfiles/blob/master/wm/.wm/scripts/interact/dmenu_windows">dmenu script</a>. But then I got to thinking, what if I had a &ldquo;switch to everything&rdquo;
script. The vision I had in my head of a single hub to jump to or DO anything was a really nice
picture, indeed. And thus, <code>dmenu_switcher</code> was born, a script I would then shout about many times.
<code>dmenu_switcher</code> is a script that matches dmenu selections to bash functions in an associated array &#x2013;
so I added actions to:
</p>

<ul class="org-ul">
<li>jump to window</li>
<li>jump to browser tab</li>
<li>jump to open file in emacs</li>
</ul>

<p>
In the process of implementing that last point, I realized I might not need dmenu after all. Within
emacs itself, I was using <a href="https://oremacs.com/swiper/">ivy</a> to switch to things. From there I learned that you can spawn an emacs
frame that is solely a minibuffer, and that meant the next step was to create a dmenu-like <a href="https://github.com/neeasade/dotfiles/blob/master/bin/bin/emacs_dmenu">script</a>
that just spawned an emacs frame containing ivy. In combination with <a href="https://github.com/raxod502/prescient.el">prescient.el</a> this means my
&ldquo;mega menu&rdquo; gets extra sorting based on selected entries &#x2013; previously selected things automatically
float to the top! How nice. However, I&rsquo;m already using dmenu in many places. This leads to me making
a script in my path also named dmenu pointing at <a href="https://github.com/neeasade/dotfiles/blob/master/bin/bin/emacs_dmenu">emacs_dmenu</a>.
</p>

<p>
Such is the state of things for a few months.
</p>


<div class="org-center">
<p>
🌿 🌿 🌿
</p>
</div>


<p>
In the past few weeks, I&rsquo;ve been practicing my touch typing. As you get a little faster, latency starts to matter. If emacs is lagging it&rsquo;s like I&rsquo;m typing through the mud (tangent: emacs was lagging and I <a href="https://github.com/syl20bnr/evil-escape/pull/91#issuecomment-622970007">found out why</a>). You start noticing things. Things like the fact that dmenu (and my <code>emacs_dmenu</code> wrapper) BLOCK UNTIL STDIN IS READ. After performing some tweaks I was down to ~100ms for gathering all the jump candidates. emacs takes about another 100ms to create a frame on my machine. A 200ms bump is quite noticable in the &ldquo;flow&rdquo; of things (you have an action in mind, you mash the keybind and start typing then OOPS I just sent gibberish to my text editor).
</p>
</div>
</div>

<div id="outline-container-org8508278" class="outline-2">
<h2 id="org8508278"><span class="section-number-2">2</span> Rofi</h2>
<div class="outline-text-2" id="text-2">
<p>
At this point I decided to check out <a href="https://github.com/davatorium/rofi">rofi</a> &#x2013; and was rewarded with the very nice <code>-async-pre-read</code>
flag. Setting the value to 0 means that rofi will start accepting keyboard input right away. That
means I can just summon the jump menu and start typing before candidates are ready. This is a golden
experience! It means I can include search candidates that take a long time to get (say, my browser
history in the past week) but still start typing right away.
</p>
</div>
</div>

<div id="outline-container-orgc95f575" class="outline-2">
<h2 id="orgc95f575"><span class="section-number-2">3</span> Tickling bash (cheating)</h2>
<div class="outline-text-2" id="text-3">
<p>
So, I&rsquo;m using rofi in dmenu mode, because I&rsquo;m using it as a dmenu replacement. This means I&rsquo;m at the mercy of the shell (pipelines waiting for stdin to be read before returning). An example is shown below (rofi pops up, you select the &rsquo;a&rsquo; option before &rsquo;b&rsquo; is ready, you are stuck):
</p>

<div class="org-src-container">
<pre class="src src-sh">(<span style="color: #0065c8;">echo</span> a; sleep 10; <span style="color: #0065c8;">echo</span> b) | rofi -dmenu -async-pre-read 0
</pre>
</div>

<p>
You see the issue with this? After I select something (intending to move on to an action), I&rsquo;m stuck again! until all the candidates have been created. Yet another bump in what I&rsquo;m trying to do. Clearly, this is an insult and I must make the machine do my bidding. This is not a fault with rofi &#x2013; it returns right away after selecting an option, as expected.
</p>

<p>
So the way I cheated was to run the &rsquo;candidate maker&rsquo; in a subshell, pass it&rsquo;s pid along to my wrapper, and kill it once rofi returned. Can&rsquo;t pass options when your dead. A shortened version of this fix may be found at the top of this post, but here&rsquo;s some links showing the use in my wrapper (gross):
</p>

<ul class="org-ul">
<li><a href="https://github.com/neeasade/dotfiles/blob/06b831a5cea3ededd76c3f4c101a4de3a56ca687/wm/.wm/scripts/interact/dmenu_switcher#L196">dmenu_switcher</a> (passes along pid to kill)</li>
<li><a href="https://github.com/neeasade/dotfiles/blob/06b831a5cea3ededd76c3f4c101a4de3a56ca687/wm/.wm/scripts/interact/dmenu#L21-L24">rofi wrapper</a> (notes the pid and kills the feeder after rofi returns)</li>
</ul>


<p>
<div class='title flair'><img class='flair-border' src='./assets/img/backgrounds/bark.jpg' /> </div>
</p>

<div class='footer-left'>
    <a href='/index.html'>🍃🌳ＧＲＯＶＥ🍃🌳</a>
</div>



<div class="footer-right">
    <a href="https://raw.githubusercontent.com/neeasade/neeasade.github.io/source/posts/2020-05-10-tickling-bash,-a-rofi-adventure.org">Page Markup</a>
</div>
</div>
</div>
</div>
</body>
</html>
